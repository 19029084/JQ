<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
	
	
<mapper namespace="com.jq.mapper.JQResourceMapper">

	<resultMap id="JQUrl" type="com.jq.entity.JQUrl">
		<id property="id" column="id"/>
		<result property="url" column="url" />
		<result property="description" column="description" />
	</resultMap>

	<select id="getUrls" resultMap="JQUrl">	
		select * from sys_url	
	</select>
	
	
	<insert id = "createUrl" keyProperty="id" useGeneratedKeys="true">
		insert into sys_url(url,description) 
		select #{url},#{description} from dual 
		where not exists ( select * from sys_url where url=#{url})
	</insert>
	
	
	<select id="findUrlByName" resultMap="JQUrl">
	
		select * from sys_url 
		where url=#{name}
	
	</select>
	

	<select id="findUserByName" resultType="com.jq.entity.JQUser">	
		select u.id as id, u.username as username, u.password as password
		from sys_user u 
		where username=#{username}				
	</select>
	


	<select id="findRolesByUserId" resultType="com.jq.entity.JQRole">	
		select r.*
		from sys_user u 
		left join sys_user_role sur on u.id=sur.user_id
		left join sys_role r on sur.role_id = r.id
		where u.id=#{userId}
	</select>


	
	<insert id = "createUser" parameterType="com.jq.entity.JQUser">
		<selectKey resultType="int" keyProperty="id" order="AFTER">
			SELECT LAST_INSERT_ID()		
		</selectKey>		
		insert into sys_user(username,password,identity) 
		select #{username},#{password},#{identity} from dual 
		where not exists ( select * from sys_user where username=#{username})
	</insert>
	
	<select id="findAllRoles" resultType="com.jq.entity.JQRole">	
		select r.*
		from sys_role r 
	</select>	
	
	<select id="findRoleByName" resultType="com.jq.entity.JQRole">	
		select r.*
		from sys_role r 
		where name=#{name}				
	</select>	


	

	<insert id = "createRole" parameterType="com.jq.entity.JQRole">
		<selectKey resultType="int" keyProperty="id" order="AFTER">
			SELECT LAST_INSERT_ID()		
		</selectKey>		
		insert into sys_role(name) 
		select #{name} from dual 
		where not exists ( select * from sys_role where name=#{name})
	</insert>
	
	<insert id = "assignRole">
		insert into sys_user_role(user_id,role_id) 
		select #{userId},#{roleId} from dual 
		where not exists ( select * from sys_user_role where user_id=#{userId} and role_id=#{roleId})
	</insert>
	
	<select id="findAllPermissions" resultType="com.jq.entity.JQPermission">	
		select * from sys_permission;
	</select>

	<select id="findPermissionsByUserId" parameterType="int" resultType="com.jq.entity.JQPermission">	
		select p.*
		from sys_user u 
		left join sys_user_role sur on u.id=sur.user_id
		left join sys_role r on sur.role_id = r.id
		left join sys_role_permission srp on srp.role_id=r.id
		left join sys_permission p on p.id = srp.permission_id		
		where u.id = #{userId}				
	</select>	
	
	<select id="findPermissionByName" resultType="com.jq.entity.JQPermission">	
		select * 
		from sys_permission
		where name=#{name}
	</select>
	
	<insert id = "createPermission" parameterType="com.jq.entity.JQPermission">
		<selectKey resultType="int" keyProperty="id" order="AFTER">
			SELECT LAST_INSERT_ID()		
		</selectKey>		
		insert into sys_permission(name,url,parentid) 
		select #{name},#{url},#{parentId} from dual 
		where not exists ( select * from sys_permission where name=#{name})
	</insert>
			
	<insert id = "assignPermission">
		insert into sys_role_permission(role_id,permission_id) 
		select #{roleId},#{permissionId} from dual 
		where not exists ( select * from sys_role_permission where role_id=#{roleId} and permission_id=#{permissionId})
	</insert>
	


</mapper>	



